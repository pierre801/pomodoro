<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Focus Timer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .play-icon { width: 0; height: 0; border-left: 14px solid currentColor; border-top: 8px solid transparent; border-bottom: 8px solid transparent; margin-left: 2px; }
        .pause-icon { display: flex; gap: 3px; }
        .pause-bar { width: 4px; height: 16px; background-color: currentColor; border-radius: 1px; }
        .stop-icon { width: 14px; height: 14px; background-color: currentColor; border-radius: 2px; }
        .reset-icon { width: 16px; height: 16px; border: 2px solid currentColor; border-radius: 50%; position: relative; border-right-color: transparent; transform: rotate(-45deg); }
        .reset-icon::after { content: ''; position: absolute; top: -3px; right: -2px; width: 0; height: 0; border-left: 6px solid currentColor; border-top: 3px solid transparent; border-bottom: 3px solid transparent; }
        .cross-icon { position: relative; width: 16px; height: 16px; }
        .cross-icon::before, .cross-icon::after { content: ''; position: absolute; width: 2px; height: 16px; background-color: currentColor; left: 50%; top: 50%; transform: translate(-50%, -50%) rotate(45deg); }
        .cross-icon::after { transform: translate(-50%, -50%) rotate(-45deg); }
        .trash-icon { position: relative; width: 14px; height: 16px; border: 2px solid currentColor; border-top: none; border-radius: 0 0 2px 2px; }
        .trash-icon::before { content: ''; position: absolute; top: -4px; left: -2px; width: 18px; height: 2px; background-color: currentColor; }
        .trash-icon::after { content: ''; position: absolute; top: -6px; left: 4px; width: 6px; height: 2px; border: 2px solid currentColor; border-bottom: none; border-radius: 2px 2px 0 0; }
        .grip-icon { display: flex; flex-direction: column; gap: 2px; justify-content: center; align-items: center; width: 10px; cursor: move; }
        .grip-dot { width: 4px; height: 4px; background-color: #cbd5e1; border-radius: 50%; }
        .card-draggable:active { cursor: grabbing; }
        .heart-icon { width: 24px; height: 24px; display: inline-block; }
        .heart-fill { fill: #EF4444; }
        .heart-empty { fill: #E5E7EB; stroke: #EF4444; stroke-width: 2; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal-animate { animation: popIn 0.3s ease-out forwards; }
        .progress-ring__circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .trophy-locked { filter: grayscale(100%); opacity: 0.4; }
        .trophy-unlocked { filter: none; opacity: 1; transform: scale(1); transition: transform 0.2s; }
        .trophy-unlocked:hover { transform: scale(1.1); }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .active-dot { animation: pulse-green 2s infinite; }
    </style>
</head>
<body class="min-h-screen bg-[#FBDEC4] text-slate-800 p-4 md:p-8">
    <div id="root"></div>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const MARKETING_PRESETS = [
            { name: "Publications semaine", duration: 12, label: "3h" },
            { name: "Exemple de segmentation", duration: 12, label: "3h" },
            { name: "Personal branding", duration: 12, label: "3h" },
            { name: "Script vid√©o", duration: 4, label: "1h" },
            { name: "Tournage", duration: 4, label: "1h" },
            { name: "Montage", duration: 16, label: "4h" },
        ];

        const BADGES_DEF = [
            { id: 'FIRST_STEP', icon: 'üå±', name: 'Premiers pas', desc: 'Terminer votre premier Pomodoro' },
            { id: 'EARLY_BIRD', icon: 'üåÖ', name: 'L√®ve-t√¥t', desc: 'Terminer un cycle avant 9h' },
            { id: 'NIGHT_OWL', icon: 'ü¶â', name: 'Oiseau de nuit', desc: 'Terminer un cycle apr√®s 22h' },
            { id: 'MARATHON', icon: 'üèÉ', name: 'Marathonien', desc: 'Faire 8 cycles en une journ√©e' },
            { id: 'STREAK_3', icon: 'üî•', name: 'R√©gulier', desc: 'S√©rie de 3 jours cons√©cutifs' },
            { id: 'MASTER', icon: 'üëë', name: 'Ma√Ætre du temps', desc: 'Atteindre le niveau 10' },
        ];

        const FullHeart = () => <svg viewBox="0 0 24 24" className="w-6 h-6 text-red-500 fill-current"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>;
        const EmptyHeart = () => <svg viewBox="0 0 24 24" className="w-6 h-6 text-red-500 fill-transparent stroke-current stroke-2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>;
        const GripHandle = () => <div className="grip-icon mr-3"><div className="flex gap-[2px]"><div className="grip-dot"></div><div className="grip-dot"></div></div><div className="flex gap-[2px]"><div className="grip-dot"></div><div className="grip-dot"></div></div><div className="flex gap-[2px]"><div className="grip-dot"></div><div className="grip-dot"></div></div></div>;
        const ProgressRing = ({ radius, stroke, progress }) => {
            const normalizedRadius = radius - stroke * 2;
            const circumference = normalizedRadius * 2 * Math.PI;
            const strokeDashoffset = circumference - (progress / 100) * circumference;
            return (
                <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none">
                    <svg height={radius * 2} width={radius * 2}>
                        <circle stroke="#e5e7eb" strokeWidth={stroke} fill="transparent" r={normalizedRadius} cx={radius} cy={radius} />
                        <circle className="progress-ring__circle" stroke="#151515" strokeWidth={stroke} strokeDasharray={circumference + ' ' + circumference} style={{ strokeDashoffset }} strokeLinecap="round" fill="transparent" r={normalizedRadius} cx={radius} cy={radius} />
                    </svg>
                </div>
            );
        };

        function PomodoroTimer() {
          const [youtubeUrl, setYoutubeUrl] = useState('');
          const [videoId, setVideoId] = useState('');
          const [isPlaylist, setIsPlaylist] = useState(false);
          const [playlistId, setPlaylistId] = useState('');
          
          const [workTime, setWorkTime] = useState(30);
          const [shortBreak, setShortBreak] = useState(0);
          const [longBreak, setLongBreak] = useState(20);
          const [timeLeft, setTimeLeft] = useState(30 * 60);
          const [totalTimeForCurrentSession, setTotalTimeForCurrentSession] = useState(30 * 60);
          
          const [isRunning, setIsRunning] = useState(false);
          const [currentCycle, setCurrentCycle] = useState(1);
          const [isWorkSession, setIsWorkSession] = useState(true);
          
          const [videoHistory, setVideoHistory] = useState([]);
          const [todayPomodoros, setTodayPomodoros] = useState(0);
          const [lastResetDate, setLastResetDate] = useState('');
          
          const [currentTask, setCurrentTask] = useState('');
          const [taskStartCycle, setTaskStartCycle] = useState(1);
          const [targetCycles, setTargetCycles] = useState(2); 
          const [tasksInProgress, setTasksInProgress] = useState([]);
          const [completedTasks, setCompletedTasks] = useState([]);
          const [taskStats, setTaskStats] = useState({});
          const [activeTaskId, setActiveTaskId] = useState(null);

          const [lives, setLives] = useState(5); 
          const [showGameOver, setShowGameOver] = useState(false);
          const [xp, setXp] = useState(0);
          const [streak, setStreak] = useState(0);
          const [badges, setBadges] = useState([]); 
          const [volume, setVolume] = useState(0.3); 
          
          const intervalRef = useRef(null);
          const audioContextRef = useRef(null);
          const playerRef = useRef(null);
          const dragItem = useRef(null);
          const dragOverItem = useRef(null);

          useEffect(() => {
            const history = JSON.parse(localStorage.getItem('pomodoroHistory') || '[]');
            const count = parseInt(localStorage.getItem('todayPomodoros') || '0');
            const date = localStorage.getItem('lastResetDate') || '';
            const tasks = JSON.parse(localStorage.getItem('completedTasks') || '[]');
            const stats = JSON.parse(localStorage.getItem('taskStats') || '{}');
            const inProgress = JSON.parse(localStorage.getItem('tasksInProgress') || '[]');
            const savedLives = parseInt(localStorage.getItem('pomodoroLives'));
            const savedXp = parseInt(localStorage.getItem('pomodoroXp') || '0');
            const savedStreak = parseInt(localStorage.getItem('pomodoroStreak') || '0');
            const savedBadges = JSON.parse(localStorage.getItem('pomodoroBadges') || '[]');
            
            setVideoHistory(history);
            setTodayPomodoros(count);
            setLastResetDate(date);
            setCompletedTasks(tasks);
            setTaskStats(stats);
            setTasksInProgress(inProgress);
            setXp(savedXp);
            setStreak(savedStreak);
            setBadges(savedBadges);
            
            if (!isNaN(savedLives)) {
                setLives(savedLives);
                if (savedLives === 0) setShowGameOver(true);
            } else { setLives(5); }

            if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
            checkDailyReset();
            checkStreakValidity(date, savedStreak);
          }, []);

          const checkStreakValidity = (lastDate, currentStreak) => {
              if (!lastDate) return;
              const today = new Date().toDateString();
              if (lastDate === today) return;
              const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
              if (lastDate !== yesterday.toDateString()) { setStreak(0); localStorage.setItem('pomodoroStreak', '0'); }
          };

          const addXp = (amount) => {
              const newXp = xp + amount; setXp(newXp); localStorage.setItem('pomodoroXp', newXp.toString());
              checkBadges(newXp);
          };

          const unlockBadge = (badgeId) => {
              if (!badges.includes(badgeId)) {
                  const newBadges = [...badges, badgeId]; setBadges(newBadges); localStorage.setItem('pomodoroBadges', JSON.stringify(newBadges));
                  if ("Notification" in window && Notification.permission === "granted") new Notification("Troph√©e d√©bloqu√© ! üèÜ", { body: BADGES_DEF.find(b => b.id === badgeId).name });
              }
          };

          const checkBadges = (currentXp = xp) => {
              if (todayPomodoros >= 1 || completedTasks.length > 0) unlockBadge('FIRST_STEP');
              if (todayPomodoros >= 8) unlockBadge('MARATHON');
              if (streak >= 3) unlockBadge('STREAK_3');
              if (currentXp >= 5000) unlockBadge('MASTER');
              const hour = new Date().getHours();
              if (hour < 9) unlockBadge('EARLY_BIRD');
              if (hour >= 22) unlockBadge('NIGHT_OWL');
          };

          const getLevel = () => Math.floor(xp / 500) + 1;
          const getXpProgress = () => ((xp % 500) / 500) * 100;

          useEffect(() => { document.title = isRunning ? `[${Math.floor(timeLeft / 60)}'] Pomodoro` : "Pomodoro Focus Timer"; }, [timeLeft, isRunning]);

          useEffect(() => {
            if (videoId && window.YT && window.YT.Player) {
              if (playerRef.current) try { playerRef.current.destroy(); } catch(e) {}
              playerRef.current = new window.YT.Player('youtube-player', {
                videoId: videoId, playerVars: { autoplay: 0, controls: 1, origin: window.location.origin },
                events: { onReady: (e) => { if (isRunning) e.target.playVideo(); } }
              });
            }
          }, [videoId]);

          const checkDailyReset = () => {
            const now = new Date(); const today = now.toDateString(); const storedDate = localStorage.getItem('lastResetDate');
            if (storedDate !== today) {
              const currentHour = now.getHours();
              if (currentHour >= 8) {
                setTodayPomodoros(0); localStorage.setItem('todayPomodoros', '0');
                localStorage.setItem('lastResetDate', today); setLastResetDate(today);
              }
            }
          };

          useEffect(() => {
            if (isRunning && timeLeft > 0) {
              intervalRef.current = setInterval(() => {
                setTimeLeft(prev => {
                  if (prev <= 10 && prev > 0) playTickSound();
                  if (prev === 1) handleCycleEnd();
                  return prev - 1;
                });
              }, 1000);
            } else { clearInterval(intervalRef.current); }
            return () => clearInterval(intervalRef.current);
          }, [isRunning, timeLeft]);

          const playTickSound = () => {
            if (!audioContextRef.current) audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
            const ctx = audioContextRef.current; const osc = ctx.createOscillator(); const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination); osc.frequency.value = 800; osc.type = 'sine';
            gain.gain.setValueAtTime(volume * 0.3, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
            osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.1);
          };

          const playBellSound = () => {
            if (!audioContextRef.current) audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
            const ctx = audioContextRef.current; const osc = ctx.createOscillator(); const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination); osc.frequency.value = 400; osc.type = 'sine';
            gain.gain.setValueAtTime(volume, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1.5);
            osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 1.5);
          };

          const handleCycleEnd = () => {
            playBellSound();
            let nextCycle = currentCycle + 1;
            if (currentCycle >= 8) { nextCycle = 1; }
            setCurrentCycle(nextCycle);
            const isNextSessionWork = (nextCycle % 2 !== 0);
            setIsWorkSession(isNextSessionWork);
            let nextDuration = 0;
            if (isNextSessionWork) {
                nextDuration = workTime * 60;
                sendNotification("Au travail", "Concentration maximale !");
            } else {
                const newPomodoros = todayPomodoros + 1;
                setTodayPomodoros(newPomodoros);
                localStorage.setItem('todayPomodoros', newPomodoros.toString());
                addXp(100); 
                const today = new Date().toDateString();
                const lastStreakDate = localStorage.getItem('lastStreakUpdateDate');
                if (lastStreakDate !== today) {
                    const newStreak = streak + 1; setStreak(newStreak);
                    localStorage.setItem('pomodoroStreak', newStreak.toString());
                    localStorage.setItem('lastStreakUpdateDate', today);
                }
                checkBadges();
                checkDailyReset();
                if (nextCycle === 8) { nextDuration = longBreak * 60; sendNotification("Pause Longue", "On souffle, fin du tour !"); }
                else { nextDuration = shortBreak * 60; sendNotification("Pause Courte", "Petite pause caf√©."); }
            }
            setTimeLeft(nextDuration);
            setTotalTimeForCurrentSession(nextDuration);
            setIsRunning(true);
            if (playerRef.current && playerRef.current.playVideo) playerRef.current.playVideo();
          };

          const toggleTimer = () => {
            if (!activeTaskId && !isRunning) {
                alert("‚ö†Ô∏è Veuillez s√©lectionner une t√¢che dans la liste 'En cours' ou en cr√©er une nouvelle pour d√©marrer le chrono !");
                return;
            }
            const newRunningState = !isRunning; setIsRunning(newRunningState);
            if (newRunningState && !audioContextRef.current) audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
            if (playerRef.current) { if (newRunningState && playerRef.current.playVideo) playerRef.current.playVideo(); else if (!newRunningState && playerRef.current.pauseVideo) playerRef.current.pauseVideo(); }
          };
          const stopTimer = () => {
            setIsRunning(false); setCurrentCycle(1); setIsWorkSession(true);
            const t = workTime * 60; setTimeLeft(t); setTotalTimeForCurrentSession(t);
            setActiveTaskId(null);
            if (playerRef.current && playerRef.current.pauseVideo) playerRef.current.pauseVideo();
          };
          const resetTimer = () => {
            setIsRunning(false); setCurrentCycle(1); setIsWorkSession(true);
            const t = workTime * 60; setTimeLeft(t); setTotalTimeForCurrentSession(t);
            if (playerRef.current && playerRef.current.pauseVideo) playerRef.current.pauseVideo();
          };

          const extractVideoId = (url) => {
            const playlistMatch = url.match(/[?&]list=([^&]+)/); if (playlistMatch) { setIsPlaylist(true); setPlaylistId(playlistMatch[1]); return null; }
            setIsPlaylist(false); const match = url.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/); return (match && match[7].length === 11) ? match[7] : null;
          };
          const loadVideo = () => {
            const id = extractVideoId(youtubeUrl); if (id || isPlaylist) { if (id) setVideoId(id); const newHistory = [{url: youtubeUrl, id: id || playlistId, isPlaylist}, ...videoHistory.filter(v => v.url !== youtubeUrl)].slice(0, 5); setVideoHistory(newHistory); localStorage.setItem('pomodoroHistory', JSON.stringify(newHistory)); }
          };
          const loadHistoryVideo = (item) => { setYoutubeUrl(item.url); setIsPlaylist(item.isPlaylist); if (item.isPlaylist) setPlaylistId(item.id); else setVideoId(item.id); };
          const deleteFromHistory = (index) => { const newHistory = videoHistory.filter((_, i) => i !== index); setVideoHistory(newHistory); localStorage.setItem('pomodoroHistory', JSON.stringify(newHistory)); };
          const clearHistory = () => { setVideoHistory([]); localStorage.setItem('pomodoroHistory', '[]'); };

          const handlePresetClick = (preset) => { setCurrentTask(preset.name); setTargetCycles(preset.duration); };
          const adjustTargetCycles = (amount) => { setTargetCycles(prev => { const newVal = prev + amount; return newVal < 2 ? 2 : newVal; }); };
          
          const startTask = () => {
            if (!currentTask.trim()) return;
            const newTask = { id: Date.now(), name: currentTask.trim(), startCycle: currentCycle, targetCycles: targetCycles, startedAt: new Date().toISOString() };
            setTasksInProgress([...tasksInProgress, newTask]); localStorage.setItem('tasksInProgress', JSON.stringify([...tasksInProgress, newTask]));
            setActiveTaskId(newTask.id); setTaskStartCycle(currentCycle); setCurrentTask(''); setIsRunning(true);
            setTotalTimeForCurrentSession(workTime * 60);
            if (!audioContextRef.current) audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
            if (playerRef.current && playerRef.current.playVideo) playerRef.current.playVideo();
          };

          const activateTask = (taskId) => { setActiveTaskId(taskId); setTaskStartCycle(currentCycle); };

          const completeTask = (taskId, e) => {
            e.stopPropagation();
            const task = tasksInProgress.find(t => t.id === taskId); if (!task) return;
            const cyclesSpent = currentCycle - task.startCycle + 1;
            addXp(50 * cyclesSpent); 
            let newLives = lives;
            if (cyclesSpent < task.targetCycles) newLives = Math.min(lives + 1, 10);
            else if (cyclesSpent > task.targetCycles) newLives = Math.max(lives - 1, 0);
            setLives(newLives); localStorage.setItem('pomodoroLives', newLives);
            if (newLives === 0) { setShowGameOver(true); stopTimer(); }
            const completedTask = { ...task, cycles: cyclesSpent, completedAt: new Date().toISOString() };
            const newCompletedTasks = [completedTask, ...completedTasks];
            setCompletedTasks(newCompletedTasks); localStorage.setItem('completedTasks', JSON.stringify(newCompletedTasks));
            const newStats = { ...taskStats };
            if (!newStats[task.name]) newStats[task.name] = { totalCycles: 0, count: 0 };
            newStats[task.name].totalCycles += cyclesSpent; newStats[task.name].count += 1;
            setTaskStats(newStats); localStorage.setItem('taskStats', JSON.stringify(newStats));
            const newTasksInProgress = tasksInProgress.filter(t => t.id !== taskId);
            setTasksInProgress(newTasksInProgress); localStorage.setItem('tasksInProgress', JSON.stringify(newTasksInProgress));
            if (activeTaskId === taskId) { setActiveTaskId(null); setIsRunning(false); if (playerRef.current && playerRef.current.pauseVideo) playerRef.current.pauseVideo(); }
            checkBadges();
          };

          const handleSort = () => {
              if (dragItem.current === null || dragOverItem.current === null) return;
              let _tasks = [...tasksInProgress];
              const draggedItemContent = _tasks.splice(dragItem.current, 1)[0];
              _tasks.splice(dragOverItem.current, 0, draggedItemContent);
              setTasksInProgress(_tasks); localStorage.setItem('tasksInProgress', JSON.stringify(_tasks));
              dragItem.current = null; dragOverItem.current = null;
          };

          const moveToInProgress = (taskId) => {
            const task = completedTasks.find(t => t.id === taskId); if (!task) return;
            const restoredTask = { id: Date.now(), name: task.name, startCycle: currentCycle, targetCycles: task.targetCycles || 2, startedAt: new Date().toISOString() };
            setTasksInProgress([...tasksInProgress, restoredTask]); localStorage.setItem('tasksInProgress', JSON.stringify([...tasksInProgress, restoredTask]));
            const newCompleted = completedTasks.filter(t => t.id !== taskId); setCompletedTasks(newCompleted); localStorage.setItem('completedTasks', JSON.stringify(newCompleted));
          };
          const deleteCompletedTask = (taskId) => { const newC = completedTasks.filter(t => t.id !== taskId); setCompletedTasks(newC); localStorage.setItem('completedTasks', JSON.stringify(newC)); };
          const clearAllCompletedTasks = () => { if (confirm("Effacer l'historique ?")) { setCompletedTasks([]); localStorage.setItem('completedTasks', '[]'); } };
          const deleteStat = (taskName) => { if (confirm(`Supprimer stats pour "${taskName}" ?`)) { const ns = { ...taskStats }; delete ns[taskName]; setTaskStats(ns); localStorage.setItem('taskStats', JSON.stringify(ns)); } };
          const restartGame = () => { setLives(5); localStorage.setItem('pomodoroLives', 5); setShowGameOver(false); };
          
          const sendNotification = (title, body) => { if ("Notification" in window && Notification.permission === "granted") new Notification(title, { body: body, icon: "https://cdn-icons-png.flaticon.com/512/3209/3209965.png" }); };
          
          const formatCycles = (c) => { const t = Math.floor(c/8), r = c%8; return t>0 ? `${t}T ${r}C` : `${r}C`; };
          const getTargetLabel = (c) => formatCycles(c);
          const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
          const getAverageTime = (name) => taskStats[name] ? Math.ceil(taskStats[name].totalCycles / taskStats[name].count) : 0;
          const todayMinutes = todayPomodoros * workTime;
          const currentRound = Math.ceil(currentCycle / 2);
          const progressPercentage = Math.min(100, Math.max(0, (timeLeft / totalTimeForCurrentSession) * 100));

          return (
            <div className="max-w-7xl mx-auto relative pb-10">
              <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                  <h1 className="text-3xl font-bold text-[#151515] text-center md:text-left">Pomodoro RPG</h1>
                  <div className="flex flex-col items-end gap-2 w-full md:w-auto">
                      <div className="flex gap-3 justify-center md:justify-end w-full">
                          <div className="bg-white px-3 py-2 rounded-xl border-2 border-[#151515] flex items-center gap-2 shadow-sm"><span className="text-xl">üî•</span><span className="font-bold text-[#151515]">{streak}</span></div>
                          <div className="bg-white px-3 py-2 rounded-xl border-2 border-[#151515] flex gap-1 shadow-sm">{[...Array(10)].map((_, i) => <div key={i} className="heart-icon">{i < lives ? <FullHeart /> : <EmptyHeart />}</div>)}</div>
                      </div>
                      <div className="bg-white p-3 rounded-xl border-2 border-[#151515] w-full md:w-64 shadow-sm">
                          <div className="flex justify-between items-end mb-1"><span className="font-bold text-sm text-[#151515]">Niveau {getLevel()}</span><span className="text-xs text-slate-500">{xp} XP</span></div>
                          <div className="w-full bg-slate-100 rounded-full h-2.5 border border-slate-200"><div className="bg-[#F2994A] h-2.5 rounded-full transition-all duration-500" style={{ width: `${getXpProgress()}%` }}></div></div>
                      </div>
                  </div>
              </div>

              {showGameOver && (
                  <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                      <div className="bg-white p-8 rounded-3xl border-4 border-red-500 max-w-lg w-full text-center modal-animate shadow-2xl">
                          <h2 className="text-5xl font-bold text-red-600 mb-6 tracking-wider">GAME OVER</h2>
                          <p className="text-xl text-[#151515] mb-8">Recommence, tu dois encore t'am√©liorer sur ta gestion du temps</p>
                          <button onClick={restartGame} className="px-8 py-4 bg-[#151515] text-white text-lg font-bold rounded-2xl hover:bg-[#333] transition border-2 border-[#151515]">Recommencer</button>
                      </div>
                  </div>
              )}

              <div className="mb-8 w-full overflow-x-auto hide-scrollbar">
                <div className="flex gap-4 min-w-max pb-2">
                    {MARKETING_PRESETS.map((preset, idx) => (
                        <button key={idx} onClick={() => handlePresetClick(preset)} className="bg-[#FEFAF5] hover:bg-white p-4 rounded-2xl border-2 border-[#151515] w-48 flex-shrink-0 flex flex-col justify-center items-center text-center transition">
                            <span className="font-bold text-[#151515] mb-1 truncate w-full">{preset.name}</span>
                            <span className="text-sm text-slate-500">{preset.label}</span>
                        </button>
                    ))}
                </div>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                {/* --- COLONNE GAUCHE (VIDEO, HISTORY, TASKS, TASK HISTORY) --- */}
                <div className="space-y-6">
                  
                  {/* VIDEO PLAYER */}
                  <div className="bg-[#FEFAF5] p-8 rounded-3xl border-2 border-[#151515]">
                    <h2 className="text-xl font-semibold mb-4 text-[#151515]">Ambiance</h2>
                    <div className="flex gap-3 mb-4">
                      <input type="text" value={youtubeUrl} onChange={(e) => setYoutubeUrl(e.target.value)} placeholder="URL YouTube" className="flex-1 px-4 py-2 bg-white border-2 border-[#151515] rounded-xl focus:outline-none" />
                      <button onClick={loadVideo} className="px-4 py-2 bg-[#151515] text-white rounded-xl text-sm font-medium">Charger</button>
                    </div>
                    <div className="aspect-video bg-slate-900 rounded-2xl overflow-hidden border-2 border-[#151515]">
                      {videoId || isPlaylist ? ( isPlaylist ? <iframe className="w-full h-full" src={`https://www.youtube.com/embed/videoseries?list=${playlistId}&autoplay=0&controls=1&origin=${window.location.origin}`} allowFullScreen></iframe> : <div id="youtube-player" className="w-full h-full"></div> ) : <div className="w-full h-full flex items-center justify-center text-slate-400 text-sm">Vid√©o ici</div>}
                    </div>
                  </div>

                  {/* VIDEO HISTORY (MOVED HERE UNDER PLAYER) */}
                  {videoHistory.length > 0 && (
                    <div className="bg-[#FEFAF5] p-8 rounded-3xl border-2 border-[#151515]">
                      <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-semibold text-[#151515]">Historique des vid√©os</h2>
                        <button onClick={clearHistory} className="text-sm px-4 py-2 bg-[#F2994A] text-[#FEFAF5] hover:bg-[#e08936] border-2 border-[#FEFAF5] rounded-xl transition">Vider</button>
                      </div>
                      <div className="space-y-3">
                        {videoHistory.map((item, idx) => (
                          <div key={idx} className="flex items-center gap-3">
                            <button onClick={() => loadHistoryVideo(item)} className="flex-1 text-left px-5 py-3 bg-white hover:bg-slate-50 border-2 border-[#151515] rounded-2xl transition text-sm truncate text-[#151515]">{item.url}</button>
                            <button onClick={() => deleteFromHistory(idx)} className="px-4 py-3 bg-[#F2994A] hover:bg-[#e08936] text-[#FEFAF5] border-2 border-[#FEFAF5] rounded-2xl transition flex items-center justify-center"><div className="cross-icon"></div></button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* EN COURS */}
                  {tasksInProgress.length > 0 && (
                    <div className="bg-[#FEFAF5] p-8 rounded-3xl border-2 border-[#151515]">
                      <h2 className="text-xl font-semibold mb-4 text-[#151515]">En cours</h2>
                      <div className="space-y-3">
                        {tasksInProgress.map((task, index) => {
                          const isActive = activeTaskId === task.id;
                          return (
                            <div key={task.id} draggable onDragStart={() => (dragItem.current = index)} onDragEnter={() => (dragOverItem.current = index)} onDragEnd={handleSort} onDragOver={(e) => e.preventDefault()} onClick={() => activateTask(task.id)} className={`p-4 rounded-2xl border-2 card-draggable transition-all cursor-pointer relative group ${isActive ? 'bg-blue-50 border-blue-500 shadow-md scale-[1.02]' : 'bg-white border-[#151515] hover:border-blue-300 hover:bg-slate-50'}`}>
                                {isActive && <div className="absolute -left-2 top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-green-500 active-dot border-2 border-white"></div>}
                                <div className="flex justify-between items-start mb-2 pl-3">
                                  <div className={`font-medium flex-1 flex items-center ${isActive ? 'text-blue-700' : 'text-[#151515]'}`}><GripHandle />{task.name}{isActive && <span className="ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">ACTIVE</span>}</div>
                                  <button onClick={(e) => completeTask(task.id, e)} className="px-3 py-1 bg-[#F2994A] hover:bg-[#e08936] text-[#FEFAF5] border-2 border-[#FEFAF5] rounded-xl text-xs transition ml-2 z-10 relative">Fini</button>
                                </div>
                                <div className="text-xs text-slate-600 font-medium pl-9">Temps: {formatCycles(currentCycle - task.startCycle + 1)} / Vis√©: {formatCycles(task.targetCycles)}</div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  {/* HISTORIQUE TACHES + STATS */}
                  {completedTasks.length > 0 && (
                    <div className="bg-[#FEFAF5] p-8 rounded-3xl border-2 border-[#151515]">
                      <div className="flex justify-between items-center mb-4">
                         <h2 className="text-xl font-semibold text-[#151515]">Historique des t√¢ches</h2>
                         <button onClick={clearAllCompletedTasks} className="text-xs px-2 py-1 bg-red-100 text-red-600 border border-red-200 rounded hover:bg-red-200">Effacer</button>
                      </div>
                      <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                        {completedTasks.slice(0, 10).map((task) => (
                          <div key={task.id} className="bg-white p-3 rounded-xl border border-slate-200 text-sm">
                            <div className="flex justify-between items-center">
                              <div className="font-medium">{task.name}</div>
                              <div className="flex gap-2">
                                <button onClick={() => moveToInProgress(task.id)} className="text-[#F2994A] hover:underline text-xs">Reprendre</button>
                                <button onClick={() => deleteCompletedTask(task.id)} className="text-slate-400 hover:text-red-500"><div className="trash-icon" style={{transform: 'scale(0.8)'}}></div></button>
                              </div>
                            </div>
                            <div className="flex justify-between mt-1 text-xs text-slate-500">
                                <span>{formatCycles(task.cycles)} / {formatCycles(task.targetCycles || 0)}</span>
                                <span className={task.cycles < task.targetCycles ? 'text-green-600 font-bold' : task.cycles > task.targetCycles ? 'text-red-500 font-bold' : ''}>
                                    {task.cycles < task.targetCycles ? '+1 Vie' : task.cycles > task.targetCycles ? '-1 Vie' : 'Neutre'}
                                </span>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {Object.keys(taskStats).length > 0 && (
                    <div className="bg-[#FEFAF5] p-8 rounded-3xl border-2 border-[#151515]">
                        <h2 className="text-xl font-semibold mb-4 text-[#151515]">Statistiques</h2>
                        <div className="space-y-3 max-h-60 overflow-y-auto pr-2">
                            {Object.entries(taskStats).map(([taskName, stats]) => (
                                <div key={taskName} className="bg-white p-3 rounded-xl border-2 border-[#151515] flex justify-between items-center text-sm">
                                    <span className="font-medium truncate flex-1 pr-2">{taskName}</span>
                                    <div className="flex items-center gap-3">
                                        <span className="text-slate-600">Moy. {formatCycles(getAverageTime(taskName))}</span>
                                        <button onClick={() => deleteStat(taskName)} className="text-slate-400 hover:text-red-500"><div className="trash-icon"></div></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                  )}
                </div>

                {/* --- COLONNE DROITE (TIMER, SETTINGS, NEW TASK, SUCCESS) --- */}
                <div className="space-y-6">
                  
                  {/* TIMER COMPRESSED */}
                  <div className="bg-[#FEFAF5] p-6 rounded-3xl border-2 border-[#151515] text-center relative overflow-visible">
                    <div className="mb-2"><span className="text-sm font-medium text-slate-600">{isWorkSession ? 'Session de travail' : 'Pause'} ‚Ä¢ Cycle {currentCycle}/8</span></div>
                    <div className="relative w-48 h-48 mx-auto mb-6 flex items-center justify-center">
                        <ProgressRing radius={96} stroke={8} progress={progressPercentage} />
                        <div className="text-5xl font-bold text-[#151515] z-10">{formatTime(timeLeft)}</div>
                    </div>
                    <div className="flex justify-center gap-3 mb-4">
                      <button onClick={toggleTimer} className={`w-16 p-3 border-2 rounded-2xl transition flex items-center justify-center ${!activeTaskId && !isRunning ? 'bg-slate-200 text-slate-400 cursor-not-allowed border-slate-300' : isRunning ? 'bg-[#F2994A] border-[#FEFAF5] text-[#FEFAF5]' : 'bg-[#FEFAF5] border-[#151515] text-[#151515]'}`}>
                        {isRunning ? <div className="pause-icon"><div className="pause-bar"></div><div className="pause-bar"></div></div> : <div className="play-icon"></div>}
                      </button>
                      <button onClick={stopTimer} className="w-16 p-3 bg-[#F2994A] border-2 border-[#FEFAF5] text-[#FEFAF5] rounded-2xl flex items-center justify-center"><div className="stop-icon"></div></button>
                      <button onClick={resetTimer} className="w-16 p-3 bg-[#F2994A] border-2 border-[#FEFAF5] text-[#FEFAF5] rounded-2xl flex items-center justify-center"><div className="reset-icon"></div></button>
                    </div>
                    <div className="text-sm font-semibold text-[#FEFAF5] bg-[#F2994A] py-2 px-4 rounded-xl border-2 border-[#151515]">
                      Aujourd'hui : {todayPomodoros} pomodoro{todayPomodoros > 1 ? 's' : ''} ({Math.floor(todayMinutes / 60)}h {todayMinutes % 60}m)
                    </div>
                  </div>
                  
                  {/* REGLAGES */}
                  <div className="bg-[#FEFAF5] p-8 rounded-3xl border-2 border-[#151515]">
                    <h2 className="text-xl font-semibold mb-4 text-[#151515]">R√©glages</h2>
                    <div className="grid grid-cols-3 gap-3 mb-6">
                        <div><label className="block text-xs font-medium mb-1 text-slate-500">Travail</label><input type="number" value={workTime} onChange={(e) => { let v = Math.max(0, Math.min(60, parseInt(e.target.value)||0)); setWorkTime(v); if (isWorkSession && !isRunning) { setTimeLeft(v*60); setTotalTimeForCurrentSession(v*60); }}} className="w-full px-2 py-2 bg-white border-2 border-[#151515] rounded-xl text-center" min="0" max="60"/></div>
                        <div><label className="block text-xs font-medium mb-1 text-slate-500">P. Courte</label><input type="number" value={shortBreak} onChange={(e) => setShortBreak(Math.max(0, Math.min(60, parseInt(e.target.value)||0)))} className="w-full px-2 py-2 bg-white border-2 border-[#151515] rounded-xl text-center" min="0" max="60"/></div>
                        <div><label className="block text-xs font-medium mb-1 text-slate-500">P. Longue</label><input type="number" value={longBreak} onChange={(e) => setLongBreak(Math.max(0, Math.min(60, parseInt(e.target.value)||0)))} className="w-full px-2 py-2 bg-white border-2 border-[#151515] rounded-xl text-center" min="0" max="60"/></div>
                    </div>
                    <div><label className="block text-xs font-medium mb-1 text-slate-500">Volume ({Math.round(volume * 100)}%)</label><input type="range" min="0" max="1" step="0.1" value={volume} onChange={(e) => setVolume(parseFloat(e.target.value))} className="w-full accent-[#151515] h-2 bg-white rounded-lg appearance-none cursor-pointer border border-[#151515]"/></div>
                  </div>

                  {/* NEW TASK */}
                  <div className="bg-[#FEFAF5] p-8 rounded-3xl border-2 border-[#151515]">
                    <h2 className="text-xl font-semibold mb-4 text-[#151515]">Nouvelle t√¢che</h2>
                    <div className="space-y-4">
                      <input type="text" value={currentTask} onChange={(e) => setCurrentTask(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && startTask()} placeholder="Nom de la t√¢che..." className="w-full px-4 py-3 bg-white border-2 border-[#151515] rounded-2xl focus:outline-none" />
                      <div className="bg-white border-2 border-[#151515] rounded-2xl p-3 flex flex-col items-center">
                          <label className="text-xs font-medium text-slate-500 mb-2">Objectif (Temps vis√©)</label>
                          <div className="flex items-center gap-4 w-full justify-between px-2">
                              <button onClick={() => adjustTargetCycles(-2)} className="w-10 h-10 flex items-center justify-center border-2 border-[#151515] rounded-xl hover:bg-slate-50"><div className="w-3 h-1 bg-current rounded-sm"></div></button>
                              <div className="text-lg font-bold text-[#151515]">{getTargetLabel(targetCycles)}</div>
                              <button onClick={() => adjustTargetCycles(2)} className="w-10 h-10 flex items-center justify-center border-2 border-[#151515] rounded-xl hover:bg-slate-50 relative"><div className="absolute w-3 h-1 bg-current rounded-sm"></div><div className="absolute w-1 h-3 bg-current rounded-sm"></div></button>
                          </div>
                      </div>
                      <button onClick={startTask} disabled={!currentTask.trim()} className="w-full px-5 py-3 bg-[#151515] hover:bg-[#2a2a2a] text-white disabled:bg-slate-300 disabled:cursor-not-allowed rounded-2xl font-medium transition border-2 border-[#151515]">GO !</button>
                    </div>
                  </div>

                  {/* SUCCES (BADGES) */}
                  <div className="bg-[#FEFAF5] p-8 rounded-3xl border-2 border-[#151515]">
                      <h2 className="text-xl font-semibold mb-4 text-[#151515]">Succ√®s</h2>
                      <div className="grid grid-cols-3 sm:grid-cols-4 gap-4">
                          {BADGES_DEF.map((badge) => {
                              const unlocked = badges.includes(badge.id);
                              return (
                                  <div key={badge.id} className={`group relative flex flex-col items-center text-center p-2 rounded-xl transition cursor-help ${unlocked ? 'bg-white border-2 border-yellow-400 trophy-unlocked' : 'opacity-50 trophy-locked'}`}>
                                      <div className="text-3xl mb-1">{badge.icon}</div>
                                      <div className="text-[10px] font-bold leading-tight">{badge.name}</div>
                                      <div className="absolute bottom-full mb-2 w-32 p-2 bg-[#151515] text-white text-[10px] rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-20 pointer-events-none shadow-xl">
                                          {badge.desc}
                                          <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-[#151515]"></div>
                                      </div>
                                  </div>
                              );
                          })}
                      </div>
                  </div>
                </div>
              </div>
            </div>
          );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PomodoroTimer />);
    </script>
</body>
</html>
